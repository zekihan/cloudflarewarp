version: "3.8"

networks:
  proxy:
    internal: true
  default:

services:
  whoami:
    image: traefik/whoami:v1.10.4
    depends_on:
      - traefik
    networks:
      - proxy
    volumes:
      - /etc/localtime:/etc/localtime:ro
    labels:
      - "traefik.http.services.test-instance-traefik-whoami.loadbalancer.server.port=80"
      - "traefik.http.services.test-instance-traefik-whoami.loadbalancer.server.scheme=http"
      - "traefik.http.services.test-instance-traefik-whoami.loadbalancer.passhostheader=true"

      - "traefik.http.routers.test-instance-traefik-whoami.service=test-instance-traefik-whoami"
      - "traefik.http.routers.test-instance-traefik-whoami.middlewares=cloudflarewarp@file"
      - "traefik.http.routers.test-instance-traefik-whoami.rule=Method(`GET`)"
      - "traefik.http.routers.test-instance-traefik-whoami.entrypoints=web"

      - "traefik.enable=true"

  traefik:
    image: traefik:v3.3.3
    networks:
      - proxy
      - default
    ports:
      - 4008:80
    volumes:
      - ./traefik-compose.toml:/etc/traefik/traefik.toml
      - ./logs:/var/logs/traefik
      - ./tempconfig:/etc/traefik/mconfig
      - ../:/plugins-local/src/github.com/zekihan/cloudflarewarp:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/localtime:/etc/localtime:ro
